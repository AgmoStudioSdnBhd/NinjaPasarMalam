# Google Maps
# Pre-requisite
This section requires a valid Google account and Google Maps app installed on your device.


## Accessing Google Cloud Console
> There is a simple way to enable Google Maps directly. Just visit https://console.developers.google.com/flows/enableapi?apiid=maps_android_backend and select the project that you want to use Google Maps

1. Go to https://cloud.google.com/

2. Login or signup for a Google account if you have not.

3. At the top right side of the website, click on "Console" beside your profile picture.

4. If you have multiple project, you can switch your project at the dropdown on the top left in the AppBar. Select the *Pasar Malam* project that you had created in Firebase Console.

5. Click on the hamburger menu (3 lines) at the top left to open the side navigation drawer  
  ![Cloud Console](https://github.com/AgmoStudioSdnBhd/NinjaPasarMalam/raw/master/art/side_nav.jpg)

6. Click on the **APIs & Services** > **Library**

7. You will see the API Library webpage
  ![Enable Maps](https://github.com/AgmoStudioSdnBhd/NinjaPasarMalam/raw/master/art/maps_api.jpg)

8. Look for "*Maps SDK for Android*" and click it.

9. Click "Enable" button.

## Google Maps in your app

1. Create Google Maps Activity via the `New` -> `Activity` -> `Google` -> `Google Maps Activity`

2. Open `AndroidManifest.xml` file in `app/src/main` directory

3. Find the Google API key and replace the value to `android:value="@string/google_api_key"`
Note: Although we didnt define `@string/google_api_key`, it was generated by the Google Services Gradle plugin when we added in `google-services.json`. Inside the file, it declares the `"api_key"`
  ```xml
  <application ...>
      // ...
      <meta-data
          android:name="com.google.android.geo.API_KEY"
          android:value="@string/google_api_key" />

  </application>
  ```

4. If you are targeting API Level 28 (Android 9.0) or above. You MUST include this code as specified here https://developers.google.com/maps/documentation/android-sdk/config#specify_requirement_for_apache_http_legacy_library.

  ```xml
  <application ...>
      // ...
      <uses-library
          android:name="org.apache.http.legacy"
          android:required="false" />

  </application>
  ```

5. In the `activity_main.xml`, give the `LinearLayout` the id `row`

6. In `MainActivity.java` find the row, and set a click listener. We will use it to launch our Map screen.

  ```java
      final View row = findViewById(R.id.row);
  ```

7. When the row is clicked, we will launch the Maps. Since we need to know what is the data of the row, we will have to wait for Firestore onComplete. We will also pass the Document ID.
  ```java
public void onComplete(@NonNull Task<QuerySnapshot> task) {
    if (task.isSuccessful()) {
        for (final DocumentSnapshot document : task.getResult()) {
            Log.d("doc", document.getId() + " => " + document.getData());

            // convert document into Pasar Malam
            PasarMalam item = document.toObject(PasarMalam.class);

            // update the UI with our data
            nameTextView.setText(item.getName());
            hoursTextView.setText(item.getHours());

            row.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    // create an Intent to start MapActivity
                    // pass in the document ID so we can find back the document
                    Intent mapIntent = new Intent(v.getContext(), MapsActivity.class);
                    mapIntent.putExtra("documentId", document.getId());
                    startActivity(mapIntent);
                }
            });
        }
    } else {
        Log.w("doc", "Error getting documents.", task.getException());
    }
}
  ```

## Updating Pin on Google Map

1. Open `MapsActivity.java`

2. In the onMapReady, we need to ask Firestore to return the Document with our ID.

3. In when Firestore completes, we set the pin to where we want based on the latitude and longitude.

  ```java
  public void onMapReady(GoogleMap googleMap) {
      mMap = googleMap;

      // get the document ID that was pass over when startActivity
      String docId = getIntent().getStringExtra("documentId");

      // ask Firestore to fetch the document with the specified Document ID
      FirebaseFirestore.getInstance()
              .collection("pasarmalam")
              .document(docId)
              .get()
              .addOnCompleteListener(this, new OnCompleteListener<DocumentSnapshot>() {
                  @Override
                  public void onComplete(@NonNull Task<DocumentSnapshot> task) {
                      PasarMalam pasarMalam = task.getResult().toObject(PasarMalam.class);
                      GeoPoint coordinate = pasarMalam.getCoordinate();
                      Log.d("doc", task.getResult().getId() + " => " + task.getResult().getData());

                      // Google Map uses LatLng, convert Firestore GeoPoint to Latlng
                      LatLng position = new LatLng(coordinate.getLatitude(), coordinate.getLongitude());

                      // set the Marker/pin attributes and add it to GMap
                      mMap.addMarker(new MarkerOptions().position(position).title(pasarMalam.getName()));

                      // move the camera to the position of the pin
                      mMap.moveCamera(CameraUpdateFactory.newLatLngZoom(position, 15));
                  }
              });
  }
  ```
